(Measure and use tool height)
(metric)
g21
(absolute position mode relative to coordinate system)
g90

; #<toolnum> = #<_hal[iocontrol.0.tool-number]>
#<toolnum> = #5400

(print, Setting height of tool #<toolnum>)
(cancel tool length compensation)
g49

#<zworkoffset> = [#[5203 + #5220 * 20] + #5213 * #5210]

(print, Z work offset is #<zworkoffset>)

(print, reference length at start is #1000)

(Move to home, first lift tool off workpiece)
G53 G0 Z0
G53 G0 x0 y0

(Extend tool measure arm)
M64 P2
M66 P1 Q30
G4 P3 (Give arm time to swing, arm extended pin P1 show up too soon)

(move spindle above tool measure arm switch)
g30

(If no tool in spindle, offset Y to hit spindle edge)
(FIXME should also orient spindle to hit cylinder, not dogs)
(FIXME do not work, pin spindle-tool-detector detect clamped, not presense)
M66 P0 L0
(#5399 = 1)
O10 IF [#5399 EQ 1]
G91 G0 y-30
#1000 = 0
O10 ENDIF

(print, Enable first tool height trigger, approach quickly)
M64 P7
G91
G38.3 Z-250 F700 (measure)
G0z.2 (off the switch)
O101 IF [#5070 EQ 0]
(print, Probe failed, lift spindle and move away)
G0 Z20
G90
O101 ELSE
G90

(print, Enable second tool height trigger, approach slowly)
M65 P7
G91
G38.2 Z-50 F50 (measure)
G0z.2 (off the switch)
G90
O20 IF [#1000 EQ 0]
#1000 = [ #5063 + #<zworkoffset> ] (save reference tool length)
(print, reference length is #1000)
O20 ENDIF
G30
(print, tool trigger height #5063)
#1001 = [#5063 + #<zworkoffset> - #1000]
G10 L1 P#<toolnum> Z#1001 (set new tool offset)
G43
(print, new length is #1001)
O101 ENDIF

M65 P2

G53 G0 Z0
G53 G0 X0 Y0

M2
